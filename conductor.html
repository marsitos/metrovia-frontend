<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ubicaci√≥n Conductor Metrov√≠a</title>
</head>
<body>
  <h1>Conductor - Env√≠o de ubicaci√≥n</h1>
  <p id="estado">Esperando ubicaci√≥n...</p>

  <script>
    // Obtener o crear un ID √∫nico para el conductor
    let ID_UNIDAD = localStorage.getItem('idUnidad');
    if (!ID_UNIDAD) {
      ID_UNIDAD = 'unidad-' + Date.now();
      localStorage.setItem('idUnidad', ID_UNIDAD);
    }

    console.log('ID asignado:', ID_UNIDAD);

    function enviarUbicacion(lat, lon) {
      const datos = {
        idUnidad: ID_UNIDAD,
        lat: lat,
        lon: lon
      };

      fetch("https://metrovia-backend.onrender.com/ubicacion", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(datos)
      })
      .then(response => {
        if (response.ok) {
          document.getElementById("estado").innerText = `Ubicaci√≥n enviada ‚úîÔ∏è (ID: ${ID_UNIDAD})`;
        } else {
          document.getElementById("estado").innerText = "Error al enviar ubicaci√≥n ‚ùå";
        }
      })
      .catch(error => {
        document.getElementById("estado").innerText = "Error: " + error.message;
      });
    }

    function obtenerYEnviarUbicacion() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            document.getElementById("estado").innerText = `Enviando lat: ${lat}, lon: ${lon} (ID: ${ID_UNIDAD})`;
            enviarUbicacion(lat, lon);
          },
          error => {
            document.getElementById("estado").innerText = "No se pudo obtener ubicaci√≥n üìç";
          }
        );
      } else {
        document.getElementById("estado").innerText = "Geolocalizaci√≥n no soportada";
      }
    }

    // Enviar ubicaci√≥n cada 10 segundos
    setInterval(obtenerYEnviarUbicacion, 10000);

    // Primer env√≠o inmediato
    obtenerYEnviarUbicacion();
  </script>
</body>
</html>
